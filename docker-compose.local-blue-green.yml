version: "3.8"

x-app-base: &app-base
  build:
    context: .
    args:
      DD_GIT_REPOSITORY_URL: ${DD_GIT_REPOSITORY_URL:-}
      DD_GIT_COMMIT_SHA: ${DD_GIT_COMMIT_SHA:-}
  env_file:
    - .env
  networks:
    - devtools-local
  restart: unless-stopped

services:
  web-blue:
    <<: *app-base
    container_name: devtools-local-blue
    environment:
      PYTHONUNBUFFERED: "1"
      LOG_DIR: /var/log/devtoolscrape
      STACK_COLOR: blue
      DD_CODE_ORIGIN_FOR_SPANS_ENABLED: "true"
      DD_EXCEPTION_REPLAY_ENABLED: "true"
    volumes:
      - ./logs/blue:/var/log/devtoolscrape
      - ./data:/app/data

  web-green:
    <<: *app-base
    container_name: devtools-local-green
    environment:
      PYTHONUNBUFFERED: "1"
      LOG_DIR: /var/log/devtoolscrape
      STACK_COLOR: green
      DD_CODE_ORIGIN_FOR_SPANS_ENABLED: "true"
      DD_EXCEPTION_REPLAY_ENABLED: "true"
    volumes:
      - ./logs/green:/var/log/devtoolscrape
      - ./data:/app/data

  router:
    image: nginx:1.27-alpine
    container_name: devtools-local-router
    depends_on:
      - web-blue
      - web-green
    networks:
      - devtools-local
    ports:
      - "8080:80"
    volumes:
      - ./deploy/nginx/local/default.conf:/etc/nginx/conf.d/default.conf:ro

  dd-agent:
    image: gcr.io/datadoghq/agent:7
    hostname: dd-agent
    env_file:
      - .env
    environment:
      - DD_API_KEY=${DATADOG_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      - DD_HOSTNAME=devtoolscrape-dd-agent
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_PROCESS_AGENT_ENABLED=false
    networks:
      - devtools-local
    ports:
      - "8126:8126"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    restart: unless-stopped

networks:
  devtools-local:
